<!DOCTYPE html>
<meta charset="UTF-8"/>
<html>
    <head>
        <title>My Experiment</title>
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/plugin-video-keyboard-response.js"></script>
        <script src="jspsych/plugin-html-button-response.js"></script>
        <script src="jspsych/plugin-call-function.js"></script>
        <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.0.0"></script>
        <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
        <script src="lib/jquery-3.4.1.min.js"></script>
        <script src="lib/require.js"></script>
        <link href="css/style.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>
        // Initialize jsPsych
        var jsPsych = initJsPsych({
            show_progress_bar: true,
            auto_update_progress_bar: false,
            minimum_valid_rt: 100,
            experiment_width: 800 
        });

        var attempts = 0;
        var n_trials = 10;

        // capture info from Prolific
        var subject_id = "asd"//jsPsych.data.getURLVariable('PROLIFIC_PID');
        var study_id = "asd"//jsPsych.data.getURLVariable('STUDY_ID');
        var session_id = "asd"//jsPsych.data.getURLVariable('SESSION_ID');

        // Array of conditions
        var conditions = [];
        for (let i = 1; i < 41; i++) {
            conditions.push(i);
        };

        // Mapping from comprehension responses to answers
        var response_index_map = {
            "Probable":0,
            "Improbable":1,
            "Impossible":2,
            "Inconceivable":3,
            "Type error":4
        }

        // Welcome plugin
        var welcome = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'Welcome to our experiment. Press any key to continue.'
        }

        // Array of stimuli for jsPsych trial
        trial_stimuli = [];

        // Randomly select ten conditions for testing
        var condition_idx = jsPsych.randomization.sampleWithoutReplacement(conditions, 1)[0];
        // Grab the current condition
        var condition = conditions[condition_idx];
        // Instantiate the empty stimuli set
        var condition_json = null;
        // Grab the stimuli JSON file for the current condition
        $.ajax({
            'async': false,
            'global': false,
            'url': "stimuli/cond_"+condition+".json",
            'dataType': "json",
            'success': function (data) {
                condition_json = data;
            }
        });

        // Record participant data
        jsPsych.data.addProperties({
            subject_id: subject_id,
            study_id: study_id,
            session_id: session_id,
            condition: condition
        });

        // Parse the stimuli components of prompt, probe, and type
        var stimuli_prompts = condition_json['prompt']
        var stimuli_probe = condition_json['probe']
        var stimuli_type = condition_json['type']
        
        // Push all of the stimuli into an Object for jsPsych
        for (let i = 0; i < Object.keys(stimuli_prompts).length; i++) {
        // for (let i = 0; i < 5; i++) {
            trial_stimuli.push({
                stimulus: stimuli_prompts[i] + " " + stimuli_probe[i],
                prompt: stimuli_prompts[i], 
                probe: stimuli_probe[i], 
                type: stimuli_type[i], 
                task_condition: condition
            });
        }

        // Prompt that precedes each stimulus
        var begin_test_prompt = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            <div style="font-size:30px;">
                <p>For the next sentence:</p> 
                <p> does it describe something that is probable, 
                    improbable, impossible, or inconceivable?</p>
                <p>(Press spacebar to begin)</p>
            </div>
            `,
            choices: " ",
            data: {
                task: 'prompt'
            }
        }

        // Prompt that follows each stimulus
        var end_test_prompt = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            <div style="font-size:30px;">
                <p>Your response has been logged.</p>
            </div>
            `,
            trial_duration: 1000,
            choices: "NO_KEYS",
            data: {
                task: 'prompt'
            }
        }

        // Procedure for the trial slides
        var test = {
            type: jsPsychHtmlButtonResponse,
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: ['Probable', 'Improbable', 'Impossible', 'Inconceivable', 'Type Error'],
            prompt: "",
            margin_vertical: "16px",
            data: {
                task: 'response',
                task_condition: jsPsych.timelineVariable('task_condition'),
                stimulus_prompt: jsPsych.timelineVariable('prompt'),
                stimulus_probe: jsPsych.timelineVariable('probe'),
                stimulus_type: jsPsych.timelineVariable('type')
            }
        }

        // Save data to CSV
        var save_data_csv = function(name, data){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'php/save_data.php'); //perhaps chane file path when you reorder the files
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({filename: name, filedata: data}));
        };

        // Grab data before the end of the experiment
        var save_data = {
            type: jsPsychCallFunction,
            func: function(){ 
                save_data_csv(subject_id + '_output', jsPsych.data.get().csv());
            },
            timing_post_trial: 0
        };

        // Final plugin for the end of the trial so participants are redicrected to
        //  Prolific and their responses are saved
        var final_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p>You've finished the last task. Thanks for participating!</p>
                <p><a href="https://app.prolific.co/submissions/complete?cc=">Click here to return to Prolific and complete the study</a>.</p>`,
            choices: "NO_KEYS"
            // ,
            // on_start: function(data) {
            //     jsPsych.data.get().localSave("csv","data/test.csv")
            // }
        }

        // The procedure for the trial
        var test_procedure = {
            timeline: [begin_test_prompt, test, end_test_prompt],
            timeline_variables: trial_stimuli,
            randomize_order: true,
            repetitions: 1
        }

        // Stimuli for consent procedure
        var consent_stimuli = [
            {   
                stimulus: `
                <div style="width:800px; text-align: left;">
                <p>
                    <strong>LABORATORY FOR COMPUTATION COGNITION & DEVELOPMENT</strong>
                    <br>
                    Department of Psychology
                    <br>
                    Harvard University
                </p>
                <p>
                    Dear Participants,
                </p>
                <p>
                    Thank you for your interest! In this study, you will:
                </p>
                <p>
                    <strong>
                        You will read short statements and be asked to categorize them in a certain way.
                    </strong>
                </p>
                <p>
                    You are being asked to participate in a project being conducted by a research team at Harvard University, under the direction of Dr. Tomer Ullman. 
                    We are interested in how people are able to reason quickly and in a commonsense way about the different objects and people they encounter in the world around them. 
                    A better understanding of commonsense reasoning has implications for building more intelligent machines that can reason in a more human-like way, lowering risk in 
                    different physical situations. During this study, you will be presented with textual descriptions of scenes. To assess your resulting mental image, you will be asked 
                    questions and you will respond by selecting an appropriate response. 
                </p>
                <p>
                    The study will last around 25 minutes. Your participation in this study is completely voluntary. You may refuse to participate, or you may choose to 
                    withdraw from participation at any time, without penalty or loss of benefit to which you are otherwise entitled. There has been no harm to people involved 
                    in this study and there are no risks associated with participation.
                </p>
                <p>
                    All information collected from the study will be associated with a randomly generated Prolific code number or Prolific ID, which 
                    is the only identifying data you will be requested to provide. Unless your profile is set to private, MTurk ID's can be used to link back to user account. 
                    We suggest you set your profile to private. This ID will be changed to Study IDs upon payment. Only researchers associated with this project will have access 
                    to the data. In order to make a research transparent to the scientific and broader community our study design and unidentifiable data might be made publicly 
                    available on Open Science Framework, a network of research materials and collaboration software, but your data will not be in anyway identifiable.
                </p>
                <p>
                    We will also provide you with a demographic questionnaire. The form does not include any personal identifying information other than your Prolific ID. Your 
                    contribution to this questionnaire is voluntary; if you choose to provide the requested information, your responses will be confidential. You will be reimbursed 
                    at a rate of [$10/hr] for your participation. You might be requested to provide you Mechanical Turk ID for reimbursement purposes, but these numbers will be deleted 
                    immediately after reimbursement. 
                </p>
                <p>
                    Your participation in our study would be greatly appreciated. If you have any questions about the project please feel free to contact us at the Lab for 
                    Computation, Cognition, and Development at the Department of Psychology, 33 Kirkland Street, Cambridge, MA 02138, or via email at cocodev@fas.harvard.edu. 
                    You may also contact the faculty member supervising this work: Tomer Ullman, Assistant Professor of Psychology, 1320 William James Hall, 33 Kirkland Street, 
                    Cambridge, MA, 02138, email: tullman@fas.harvard.edu
                </p>
                <p>
                    Whom to contact about your rights in this research, for questions, concerns, suggestions, or complaints that are not being addressed by the researcher, 
                    or research-related harm: Committee on the Use of Human Subjects in Research at Harvard University. Phone:  617-496-CUHS (2847).  Email: cuhs@harvard.edu. 
                    Please print this screen for your records.
                </p>
                <p>
                    <strong>Consent Statement</strong>
                </p>
                <p>
                    If you agree to participate, please click the consent button below. Thank you very much for your time and consideration.
                </p>
                <p>
                    By selecting the <strong>Consent</strong> button below, I acknowledge that I am 18 or older, have read this consent form, and I agree to take part in the Commonsense Reasoning 
                    about Physics and Psychology project conducted by the research lab of Dr. Tomer Ullman.
                </p>
                <p>
                    If you do NOT agree to participate in this study, please click the <strong>Decline</strong> button below.
                </p>
                <div>
                `
            }
        ]

        // Consent process
        var consent = {
            type: jsPsychHtmlButtonResponse,
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: ["Consent", "Decline"],
            prompt: "<p><br></p>",
            margin_vertical: "10px",
            data: {
                task: 'consent'
            },
            on_finish: function(data){
                if (data.response == 1){
                    jsPsych.endExperiment(`
                        <p>
                            You've declined to consent to our experiment. 
                        </p>
                        <p>
                            If this was done in error, please consider re-loading the experiment page and consent to the experiment.
                        </p>
                        <p>
                            Thank you for taking the time to consider our experiment.
                        </p>
                    `);
                }
            }
        }

        // Consent procedure
        var consent_procedure = {
            timeline: [consent],
            timeline_variables: consent_stimuli
        }

        // Instructions procedure
        var instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            '<div style='width:800px;'>
                <p>
                We need your help deciding whether some things are <strong>probable</strong>, <strong>improbable</strong>, <strong>impossible</strong>, <strong>inconceivable</strong>, or a <strong>type error</strong>. 
                </p>
                <p>
                <strong>Probable</strong> means it is something that can happen. 
                <p>
                <strong>Improbable</strong> means it is something that can happen but not usual or likely. 
                <p>
                <strong>Impossible</strong> means it is something that can't happen. 
                <p>
                <strong>Inconceivable</strong> means it is something that cannot be imagined or construed. 
                <p>
                A <strong>type error</strong> means the statement breaks the rules of English grammar.
                </p>
                <p>
                You are going to be given 100 statements. Please categorize them into one of the five categories above.
                <p>
                Once you are done reading please press any key to continue.
                </p>
            </div>
                `
        }

        // Pre-comprehension
        var pre_compre = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            '<div style='width:800px;'>
                <p>
                    We are almost ready for the study. 
                    Before we start, we have a few comprehension questions, 
                    to make sure you understand the task.
                </p>
                <p>
                    You will see a few statements and be asked to categorize them into one of the five categories of probable, improbable, impossible, inconceivable, and type error.
                </p>
                <p>
                    Press spacebar to begin.
                </p>
                `
        }

        // Comprehension stimuli
        var compre_stimuli = [
            {q: "drinking a glass of water",a:'Probable'}, 
            {q: "moving furniture with your mind",a:'Impossible'}, 
            {q: "finding an alligator under your bed",a:'Improbable'},
            {q: "pouring yourself a glass of honey",a:'Improbable'},
            {q: "painting the clouds in the sky pink",a: 'Impossible'},
            {q: "locking a door with an everyday",a:'Type error'},
            {q:"staying awake for 5 kilograms",a: 'Inconceivable'}, 
            {q:"building a house of big",a: 'Type error'},
            {q: "eating vegetables for dinner",a: 'Probable'},
            {q: "smashing a pumpkin with sadness",a: 'Inconceivable'}
        ];

        // Comprehension process
        var comprehension = {
            type: jsPsychHtmlButtonResponse,
            prompt: '<p><b>Please categorize ALL these statements correctly to move on to the actual experiment.</b></p>',
            stimulus: jsPsych.timelineVariable('q'),
            choices: ['Probable', 'Improbable', 'Impossible', 'Inconceivable', 'Type error'],
            margin_vertical: "16px",
            data: {
                task: 'comprehension',
                correct_response: jsPsych.timelineVariable('a'),
                attempts: 1
            },
            on_finish: function(data){
                data.correct = (data.response == response_index_map[data.correct_response]);
                data.attempts = attempts;
                var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
                jsPsych.setProgressBar(curr_progress_bar_value + (1/n_trials));
            }
        }

        // Comprehension procedure
        var comprehension_procedure = {
            timeline: [comprehension],
            timeline_variables: compre_stimuli,
            loop_function: function(data){
                responses = data.filter({task: "comprehension"});
                console.log(responses)
                correct_responses = responses.select("correct");
                console.log(correct_responses)
                if (correct_responses.values.every(Boolean)) {
                    return false; // don't loop
                }
                else {
                    attempts += 1;
                    alert("You answered one or more questions incorrectly! Try to pay attention this time and answer the questions correctly.")
                    return true; // loop
                }
            }
        }

        // Post-comprehension check
        var begin = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus:  `'<p>Congratulations, you passed the comprehension check! Now we will move onto the experiment.</p>
            <p>Remember, your task is to categorize sentences into one of these five categories: 
            <p><strong>Probable</strong> (something that can happen),</p>
            <p><strong>Improbable</strong> (something that can happen but not usual or likely),</p>
            <p><strong>Impossible</strong> (something that can't happen),</p>
            <p><strong>Inconceivable</strong>(something that cannot be imagined or construed),</p>
            <p><strong>Type error</strong> (something that breaks the rules of English grammar).</p>
            <p>For the trials, we will show you one sentence at a time. Please try to categorize the sentence as quickly as you can. 
            </p>' 
            <p>Press any key to continue.</p>`
        }

        // Timeline for jsPsych
        var timeline = [];
        timeline.push(welcome);
        timeline.push(consent_procedure);
        timeline.push(instructions);
        timeline.push(pre_compre);
        timeline.push(comprehension_procedure);
        timeline.push(begin);
        timeline.push(test_procedure);
        timeline.push(save_data)
        timeline.push(final_trial)
        jsPsych.run(timeline);

    </script>
</html>